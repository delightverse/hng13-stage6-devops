name: üö¢ Application Deployment

on:
  push:
    branches:
      - main
    paths:
      - 'frontend/**'
      - 'auth-api/**'
      - 'todos-api/**'
      - 'users-api/**'
      - 'log-message-processor/**'
      - 'docker-compose.yml'
      - '.env.example'
  pull_request:
    branches:
      - main
    paths:
      - 'frontend/**'
      - 'auth-api/**'
      - 'todos-api/**'
      - 'users-api/**'
      - 'log-message-processor/**'
      - 'docker-compose.yml'
  workflow_dispatch:

env:
  ANSIBLE_VERSION: '2.15.0'

jobs:
  detect-changes:
    name: üîç Detect Changed Services
    runs-on: ubuntu-latest
    outputs:
      frontend: ${{ steps.changes.outputs.frontend }}
      auth-api: ${{ steps.changes.outputs.auth-api }}
      todos-api: ${{ steps.changes.outputs.todos-api }}
      users-api: ${{ steps.changes.outputs.users-api }}
      log-processor: ${{ steps.changes.outputs.log-processor }}
      docker-compose: ${{ steps.changes.outputs.docker-compose }}
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: üîç Check for changes
        id: changes
        run: |
          echo "frontend=$(git diff --name-only HEAD~1 HEAD | grep -q '^frontend/' && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "auth-api=$(git diff --name-only HEAD~1 HEAD | grep -q '^auth-api/' && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "todos-api=$(git diff --name-only HEAD~1 HEAD | grep -q '^todos-api/' && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "users-api=$(git diff --name-only HEAD~1 HEAD | grep -q '^users-api/' && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "log-processor=$(git diff --name-only HEAD~1 HEAD | grep -q '^log-message-processor/' && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "docker-compose=$(git diff --name-only HEAD~1 HEAD | grep -q 'docker-compose.yml' && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT

  build-services:
    name: üî® Build Services
    runs-on: ubuntu-latest
    needs: detect-changes
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üê≥ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: üèóÔ∏è Build Frontend
        if: needs.detect-changes.outputs.frontend == 'true' || needs.detect-changes.outputs.docker-compose == 'true'
        run: docker build -t todo-frontend:${{ github.sha }} ./frontend

      - name: üèóÔ∏è Build Auth API
        if: needs.detect-changes.outputs.auth-api == 'true' || needs.detect-changes.outputs.docker-compose == 'true'
        run: docker build -t todo-auth-api:${{ github.sha }} ./auth-api

      - name: üèóÔ∏è Build Todos API
        if: needs.detect-changes.outputs.todos-api == 'true' || needs.detect-changes.outputs.docker-compose == 'true'
        run: docker build -t todo-todos-api:${{ github.sha }} ./todos-api

      - name: üèóÔ∏è Build Users API
        if: needs.detect-changes.outputs.users-api == 'true' || needs.detect-changes.outputs.docker-compose == 'true'
        run: docker build -t todo-users-api:${{ github.sha }} ./users-api

      - name: üèóÔ∏è Build Log Processor
        if: needs.detect-changes.outputs.log-processor == 'true' || needs.detect-changes.outputs.docker-compose == 'true'
        run: docker build -t todo-log-processor:${{ github.sha }} ./log-message-processor

      - name: ‚úÖ Build Complete
        run: echo "All services built successfully!"

  deploy-application:
    name: üöÄ Deploy Application
    runs-on: ubuntu-latest
    needs: [detect-changes, build-services]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üêç Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: üì¶ Install Ansible
        run: pip install ansible==${{ env.ANSIBLE_VERSION }}

      - name: üîê Configure SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts

      - name: üìã Create Ansible Inventory
        run: |
          cat > infra/ansible/inventory.ini <<EOF
          [app_servers]
          ${{ secrets.SERVER_IP }} ansible_user=root ansible_ssh_private_key_file=~/.ssh/id_rsa

          [app_servers:vars]
          github_repo_url=${{ github.server_url }}/${{ github.repository }}
          github_branch=${{ github.ref_name }}
          domain=${{ secrets.DOMAIN }}
          jwt_secret=${{ secrets.JWT_SECRET }}
          cf_api_email=${{ secrets.CF_API_EMAIL }}
          cf_dns_api_token=${{ secrets.CF_DNS_API_TOKEN }}
          ansible_python_interpreter=/usr/bin/python3
          ansible_ssh_common_args='-o StrictHostKeyChecking=no'
          app_directory=/opt/todo-app
          EOF

      - name: üé≠ Run Ansible Playbook
        run: |
          cd infra/ansible
          ansible-playbook -i inventory.ini playbook.yml --tags deploy

      - name: ‚úÖ Deployment Complete
        run: echo "Application deployed to https://${{ secrets.DOMAIN }}"

  verify-deployment:
    name: ‚úÖ Verify Deployment
    runs-on: ubuntu-latest
    needs: deploy-application
    
    steps:
      - name: üîç Check Frontend
        run: |
          curl -sSf https://${{ secrets.DOMAIN }} > /dev/null
          echo "‚úÖ Frontend is accessible"

      - name: üîç Check Auth API
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" https://${{ secrets.DOMAIN }}/api/auth/version)
          if [ "$response" -eq 200 ] || [ "$response" -eq 404 ]; then
            echo "‚úÖ Auth API is responding"
          else
            echo "‚ö†Ô∏è Auth API returned: $response"
          fi

      - name: ‚úÖ Verification Complete
        run: echo "All services verified!"

  notify-deployment:
    name: üìß Send Deployment Notification
    runs-on: ubuntu-latest
    needs: [deploy-application, verify-deployment]
    if: always()
    
    steps:
      - name: üìß Send Email Notification
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: '${{ needs.verify-deployment.result == ''success'' && ''‚úÖ'' || ''‚ùå'' }} Application Deployment - ${{ github.repository }}'
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          from: 'DevOps CI/CD <${{ secrets.EMAIL_USERNAME }}>'
          body: |
            Application Deployment ${{ needs.verify-deployment.result == 'success' && 'Successful' || 'Failed' }}!
            
            Repository: ${{ github.repository }}
            Branch: ${{ github.ref_name }}
            Commit: ${{ github.sha }}
            
            Application URL: https://${{ secrets.DOMAIN }}
            
            View Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
