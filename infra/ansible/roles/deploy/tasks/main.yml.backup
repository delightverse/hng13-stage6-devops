---
- name: Ensure Traefik directory exists
  file:
    path: "{{ app_directory }}/traefik"
    state: directory
    mode: '0755'
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"

- name: Create acme.json for SSL certificates
  file:
    path: "{{ app_directory }}/traefik/acme.json"
    state: touch
    mode: '0600'
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
  changed_when: false

- name: Check if repository exists
  stat:
    path: "{{ app_directory }}/.git"
  register: git_repo

- name: Clone repository
  git:
    repo: "{{ github_repo_url }}"
    dest: "{{ app_directory }}"
    version: "{{ github_branch }}"
    force: no
  when: not git_repo.stat.exists

- name: Pull latest changes
  git:
    repo: "{{ github_repo_url }}"
    dest: "{{ app_directory }}"
    version: "{{ github_branch }}"
    force: yes
  when: git_repo.stat.exists
  register: git_pull

- name: Create .env file
  template:
    src: env.j2
    dest: "{{ app_directory }}/.env"
    mode: '0600'
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
  notify: restart application

- name: Update Traefik email in configuration
  lineinfile:
    path: "{{ app_directory }}/traefik/traefik.yml"
    regexp: '^      email:.*'
    line: '      email: "{{ cf_api_email }}"'
    backrefs: yes
  notify: restart traefik

- name: Stop existing containers
  community.docker.docker_compose_v2:
    project_src: "{{ app_directory }}"
    state: absent
  when: git_pull.changed
  ignore_errors: yes

- name: Build Docker images
  command: docker compose build --no-cache
  args:
    chdir: "{{ app_directory }}"
  when: git_pull.changed or not git_repo.stat.exists
  register: docker_build
  changed_when: "'Successfully built' in docker_build.stdout or 'Successfully tagged' in docker_build.stdout"

- name: Start application with Docker Compose
  community.docker.docker_compose_v2:
    project_src: "{{ app_directory }}"
    state: present
    pull: always
    build: no
    recreate: smart
  register: docker_compose_result

- name: Wait for Traefik to be healthy
  uri:
    url: "http://localhost:8080/ping"
    status_code: 200
    timeout: 5
  register: traefik_health
  until: traefik_health.status == 200
  retries: 30
  delay: 10
  ignore_errors: yes

- name: Display container status
  command: docker compose ps
  args:
    chdir: "{{ app_directory }}"
  register: container_status
  changed_when: false

- name: Show running containers
  debug:
    msg: "{{ container_status.stdout_lines }}"

- name: Set up log rotation for application
  copy:
    content: |
      {{ app_directory }}/logs/*.log {
        daily
        rotate 14
        compress
        delaycompress
        notifempty
        create 0640 {{ ansible_user }} {{ ansible_user }}
        sharedscripts
        postrotate
          docker compose -f {{ app_directory }}/docker-compose.yml restart > /dev/null 2>&1 || true
        endscript
      }
    dest: /etc/logrotate.d/todo-app
    mode: '0644'

- name: Create systemd service
  template:
    src: docker-compose.service.j2
    dest: /etc/systemd/system/todo-app.service
    mode: '0644'
  notify: reload systemd

- name: Enable todo-app service
  systemd:
    name: todo-app
    enabled: yes
    daemon_reload: yes
